# FavaleTrainer CRM - Sistema de CRM para Personal Trainers

## 📋 Visão Geral

O **FavaleTrainer CRM** é um sistema completo de gerenciamento de relacionamento com clientes (CRM) desenvolvido especificamente para personal trainers da empresa Favale. O sistema integra funcionalidades modernas de gestão de leads, tarefas, comunicação via WhatsApp e análise de dados, proporcionando uma solução completa para profissionais de fitness.

## 🏗️ Arquitetura e Stack Tecnológica

### **Frontend**
- **Next.js 15.3.4** - Framework React com App Router e Turbopack
- **TypeScript 5.2.2** - Tipagem estática robusta
- **Tailwind CSS 3.3.3** - Framework CSS utilitário com animações
- **shadcn/ui** - Biblioteca de componentes UI moderna e acessível
- **Radix UI** - Componentes primitivos de alta qualidade
- **Framer Motion 12.20.1** - Animações fluidas e transições avançadas
- **Lucide React 0.446.0** - Ícones SVG otimizados e consistentes
- **React Hook Form 7.60.0** - Gerenciamento performático de formulários
- **Zod 3.25.75** - Validação de schemas TypeScript-first
- **React Big Calendar 1.19.4** - Calendário avançado para agendamentos
- **Recharts 2.12.7** - Gráficos e visualizações de dados

### **Backend & Database**
- **Supabase** - Backend-as-a-Service (PostgreSQL + Auth + Realtime)
- **Edge Functions** - Processamento serverless
- **Row Level Security (RLS)** - Segurança a nível de linha
- **Realtime Subscriptions** - Atualizações em tempo real

## 🔗 Integrações e APIs

### **Integrações Externas**
- **Evolution API** - Integração WhatsApp Business (HTTP nativo otimizado)
- **Chatwoot** - Interface de chat integrada para WhatsApp
- **Vercel KV** - Cache Redis distribuído para performance
- **Papa Parse** - Processamento CSV em lote otimizado
- **Date-FNS** - Manipulação de datas avançada
- **Date-Holidays** - Sistema de feriados automático
- **RRule** - Regras de recorrência para agendamentos

### **Gerenciamento de Estado**
- **React Query (TanStack Query) 5.17.0** - Cache inteligente e sincronização de dados
- **React Context** - Estado global de autenticação
- **React Hooks** - Estados locais e efeitos otimizados
- **Zustand** - Estado leve para componentes específicos
- **Custom Hooks** - Lógica reutilizável e performática

## 🔧 Estrutura do Projeto

```
NextCRM/
├── app/                          # App Router (Next.js 13+)
│   ├── api/                      # API Routes
│   │   ├── leads/                # Gestão de leads
│   │   ├── whatsapp/             # Integração WhatsApp
│   │   └── test-evolution/       # Testes da Evolution API
│   ├── auth/                     # Páginas de autenticação
│   ├── dashboard/                # Dashboard principal
│   ├── leads/                    # Gestão de leads
│   ├── students/                 # Gestão de alunos
│   ├── tasks/                    # Gestão de tarefas
│   ├── whatsapp/                 # Interface WhatsApp
│   ├── layout.tsx                # Layout raiz
│   └── page.tsx                  # Página inicial
├── components/                   # Componentes React
│   ├── Dashboard/                # Componentes do dashboard
│   ├── Layout/                   # Layouts da aplicação
│   ├── Leads/                    # Componentes de leads
│   ├── Tasks/                    # Componentes de tarefas
│   ├── Whatsapp/                 # Componentes WhatsApp
│   └── ui/                       # Biblioteca shadcn/ui
├── contexts/                     # React Contexts
├── hooks/                        # Custom Hooks
├── lib/                          # Utilitários e serviços
├── types/                        # Definições TypeScript
├── utils/                        # Funções utilitárias
└── supabase/                     # Migrações e configurações
    └── migrations/               # Migrations SQL
```

## 🚀 Funcionalidades Principais

### **1. Gestão de Leads**

#### **Importação de Leads**
- **Importação em lote via CSV** com template pré-definido
- **Processamento assíncrono** em chunks para grandes volumes
- **Validação automática** de dados (email, telefone, status)
- **Sistema de tags** para categorização
- **Suporte a múltiplas empresas** (Favale Functional, Personal, etc.)

#### **Gestão Individual**
- **CRUD completo** com interface intuitiva
- **Status personalizáveis**: New, Contacted, Converted, Lost
- **Campos flexíveis**: nome, email, telefone, empresa, fonte, tags
- **Relacionamento com alunos** - conversão automática
- **Histórico de interações** e anotações

#### **Funcionalidades Avançadas**
- **Operações em lote**: edição e exclusão múltipla
- **Filtros avançados**: por status, empresa, data, tags
- **Busca inteligente**: nome, email, telefone
- **Exportação de dados**
- **Interface responsiva** com tabelas otimizadas

### **2. Sistema de Tarefas (Kanban)**

#### **Organização Visual**
- **Board Kanban** com colunas personalizáveis
- **Drag & Drop** para movimentação de tarefas
- **Cores por prioridade**: Low (verde), Medium (azul), High (laranja), Urgent (vermelho)
- **Cards informativos** com dados relevantes

#### **Gestão de Tarefas**
- **Prioridades configráveis**: Low, Medium, High, Urgent
- **Datas de vencimento** com alertas visuais
- **Associação com leads** para contexto
- **Estados**: To Do, In Progress, Review, Done
- **Descrições detalhadas** e anotações

#### **Produtividade**
- **Filtros por status** e prioridade
- **Notificações de prazo** e tarefas pendentes
- **Métricas de produtividade** no dashboard
- **Sincronização em tempo real** entre usuários

### **3. Integração WhatsApp Business**

#### **Configuração da Evolution API**
- **Instância dedicada "Leonardo"** auto-configurada
- **QR Code automático** para pareamento
- **Status de conexão** em tempo real
- **Webhook inteligente** para recebimento de mensagens

**Arquitetura Refatorada (Julho 2024):**
A integração com o WhatsApp foi significativamente refatorada para simplificar e robustecer a comunicação. As principais mudanças incluem:
- **Endpoint de API Consolidado**: Todas as interações de gerenciamento da instância do WhatsApp (verificar status, obter QR code, conectar, reconectar, desconectar) foram centralizadas no endpoint `GET / POST /api/whatsapp/instance`. Isso substitui múltiplos endpoints anteriores (`/status`, `/connection`, `/reconnect`, etc.).
- **Serviço HTTP Otimizado**: O `lib/evolution-http.service.ts`, utilizando `fetch` nativo e retry robusto, é a única interface de comunicação com a API externa da Evolution. O antigo `lib/evolution.service.ts` (baseado em Axios) foi removido.
- **Processador de Webhook Eficiente**: O `app/api/whatsapp/webhook/route.ts` (e sua rota catch-all `app/api/whatsapp/webhook/[...event]/route.ts` para lidar com `webhook_by_events: true`) atuam como pontos de entrada únicos, validando e passando imediatamente os dados para o `lib/webhook.processor.ts`. Este processador foi otimizado para maior clareza e idempotência no tratamento de eventos.
- **Hook de Conexão Frontend Simplificado**: O hook `hooks/useWhatsAppConnection.ts` foi refatorado para usar `@tanstack/react-query` (`useQuery` para polling de status e `useMutation` para ações), comunicando-se exclusivamente com o novo endpoint `/api/whatsapp/instance`.
- **Schema de Banco de Dados Consolidado**: A tabela `whatsapp_connections` foi alterada para um modelo de instância única, utilizando `instance_name` como chave primária em vez de `user_id`, refletindo a arquitetura de uma instância global ("Leonardo") gerenciada pelo sistema. A tabela `whatsapp_messages` agora inclui uma coluna `instance_name`. Essas alterações foram aplicadas através de uma nova migração consolidada.

Essa refatoração resulta em um fluxo de dados mais limpo, menos redundância, melhor tratamento de erros e maior facilidade de manutenção da integração com o WhatsApp.

#### **Comunicação Integrada**
- **Chat nativo** dentro do CRM
- **Envio de mensagens** direto dos leads
- **Suporte a mídias**: imagens, vídeos, áudios, documentos
- **Histórico completo** de conversas
- **Rate limiting** inteligente (30 msg/min)

#### **Recursos Avançados**
- **Lista de conversas** com último contato
- **Indicadores de mensagens** não lidas
- **Busca em conversas** e contatos
- **Interface familiar** similar ao WhatsApp Web
- **Notificações em tempo real**

### **4. Dashboard Analítico**

#### **KPIs Principais**
- **Total de Leads** com tendência mensal
- **Taxa de Conversão** leads → alunos
- **Alunos Ativos** e crescimento
- **Tarefas Pendentes** e concluídas
- **Sessões de Treino** (ativas/concluídas)

#### **Visualizações**
- **Gráficos interativos** (Chart.js/Recharts)
- **Métricas por período** (diário, semanal, mensal)
- **Distribuição por fonte** de leads
- **Status pipeline** visual
- **Heatmap de atividades**

#### **Relatórios**
- **Performance temporal** com comparativos
- **Análise de conversão** por canal
- **Produtividade pessoal** e da equipe
- **Insights automáticos** baseados em dados

### **6. Sistema de Agendamento Avançado**

#### **Calendário Inteligente**
- **React Big Calendar** integrado com interface moderna
- **Visualizações múltiplas**: mês, semana, dia, agenda
- **Localização pt-BR** completa com feriados brasileiros
- **Responsividade total** em dispositivos móveis
- **Sincronização em tempo real** entre usuários

#### **Agendamentos Recorrentes**
- **RRule integration** para padrões complexos de recorrência
- **Agendamentos semanais** personalizados por aluno
- **Gerenciamento de ausências** e reagendamentos
- **Conflitos automáticos** detectados e resolvidos
- **Notificações inteligentes** de lembrete

#### **Disponibilidade de Professores**
- **Horários personalizados** por dia da semana
- **Bloqueios de agenda** para férias e ausências
- **Capacidade por horário** configurável
- **Feriados nacionais** automaticamente considerados
- **Exceções pontuais** facilmente gerenciadas

#### **Serviços e Preços**
- **Catálogo de serviços** com duração e preços
- **Pacotes personalizados** para diferentes modalidades
- **Histórico de sessões** completo por aluno
- **Relatórios de frequência** e performance
- **Controle de inadimplência** automático

### **7. Gestão de Alunos Aprimorada**

#### **Conversão Automática**
- **Leads → Alunos** com um clique
- **Relacionamento bidirecional** preservado
- **Histórico mantido** durante conversão
- **Status diferenciado** na interface
- **Badge visual** para identificação rápida

#### **Acompanhamento Detalhado**
- **Lista dedicada** de alunos ativos
- **Progresso individual** e metas
- **Sessões de treino** agendadas/realizadas
- **Comunicação direta** via WhatsApp
- **Histórico completo** de interações
- **Métricas de performance** personalizadas

### **8. Analytics e Relatórios Avançados**

#### **Dashboard Interativo**
- **Activity Heatmap** com padrões de uso
- **Gráficos de tendência** de conversão
- **Métricas em tempo real** de performance
- **Comparativos período anterior** automáticos
- **Projeções inteligentes** baseadas em dados históricos

#### **Insights Automáticos**
- **Detecção de padrões** em comportamento de leads
- **Sugestões de otimização** personalizadas
- **Alertas de performance** proativos
- **Recomendações de ação** baseadas em IA
- **Benchmarking automático** com mercado

## 🗄️ Estrutura do Banco de Dados

### **Tabelas Principais**

#### **leads**
```sql
- id (UUID, PK)
- user_id (UUID, FK → auth.users)
- name (TEXT, NOT NULL)
- email (TEXT, UNIQUE)
- phone (TEXT)
- company (TEXT) -- Favale Functional, Personal, etc.
- status (TEXT) -- New, Contacted, Converted, Lost
- source (TEXT) -- Instagram, Indicação, Site, etc.
- tags (TEXT[])
- created_at, updated_at (TIMESTAMP)
```

#### **students**
```sql
- id (UUID, PK)
- lead_id (UUID, FK → leads.id)
- user_id (UUID, FK → auth.users)
- enrollment_date (DATE)
- status (TEXT) -- Active, Inactive, Suspended
- created_at, updated_at (TIMESTAMP)
```

#### **tasks**
```sql
- id (UUID, PK)
- user_id (UUID, FK → auth.users)
- title (TEXT, NOT NULL)
- description (TEXT)
- status (TEXT) -- To Do, In Progress, Review, Done
- priority (TEXT) -- Low, Medium, High, Urgent
- due_date (DATE)
- related_lead_id (UUID, FK → leads.id)
- created_at, updated_at (TIMESTAMP)
```

#### **whatsapp_connections (Refatorada)**
```sql
- instance_name (TEXT, PK) -- Chave primária única por instância
- status (TEXT) -- connecting, qr_ready, connected, disconnected, error
- qr_code (TEXT)
- whatsapp_user (JSONB)
- phone_number (TEXT)
- connected_at (TIMESTAMPTZ)
- disconnected_at (TIMESTAMPTZ)
- error_message (TEXT)
- created_at, updated_at (TIMESTAMPTZ)
```

#### **whatsapp_messages (Atualizada)**
```sql
- id (UUID, PK)
- lead_id (UUID, FK → leads.id)
- user_id (UUID, FK → auth.users)
- instance_name (TEXT) -- Referência à instância WhatsApp
- message_content (TEXT)
- media_url (TEXT)
- media_type (TEXT)
- is_from_lead (BOOLEAN)
- message_timestamp (TIMESTAMPTZ)
- evolution_message_id (TEXT)
- created_at (TIMESTAMPTZ)
```

#### **training_sessions**
```sql
- id (UUID, PK)
- student_id (UUID, FK → students.id)
- user_id (UUID, FK → auth.users)
- scheduled_date (TIMESTAMP)
- actual_date (TIMESTAMP)
- status (TEXT) -- Scheduled, Completed, Cancelled, No-show
- notes (TEXT)
- created_at, updated_at (TIMESTAMP)
```

#### **recurring_sessions**
```sql
- id (UUID, PK)
- student_id (UUID, FK → students.id)
- teacher_id (UUID, FK → trainers.id)
- service_id (UUID, FK → services.id)
- start_date (TIMESTAMPTZ)
- end_date (TIMESTAMPTZ)
- rrule (TEXT) -- String RRule para recorrência
- user_id (UUID, FK → auth.users)
- created_at, updated_at (TIMESTAMPTZ)
```

#### **teacher_availability**
```sql
- id (UUID, PK)
- teacher_id (UUID, FK → trainers.id)
- day_of_week (INTEGER) -- 0-6 (Domingo-Sábado)
- start_time (TIME)
- end_time (TIME)
- is_available (BOOLEAN)
- user_id (UUID, FK → auth.users)
- created_at (TIMESTAMPTZ)
```

#### **teacher_absences**
```sql
- id (UUID, PK)
- teacher_id (UUID, FK → trainers.id)
- start_date (TIMESTAMPTZ)
- end_date (TIMESTAMPTZ)
- reason (TEXT)
- is_recurring (BOOLEAN)
- user_id (UUID, FK → auth.users)
- created_at (TIMESTAMPTZ)
```

#### **services**
```sql
- id (UUID, PK)
- name (TEXT, NOT NULL)
- description (TEXT)
- duration_minutes (INTEGER) -- Duração padrão em minutos
- price (DECIMAL(10,2))
- is_active (BOOLEAN)
- user_id (UUID, FK → auth.users)
- created_at (TIMESTAMPTZ)
```

#### **holidays**
```sql
- id (UUID, PK)
- name (TEXT, NOT NULL)
- date (DATE)
- is_national (BOOLEAN) -- Feriado nacional ou personalizado
- description (TEXT)
- user_id (UUID, FK → auth.users)
- created_at (TIMESTAMPTZ)
```

### **Recursos de Segurança**

#### **Row Level Security (RLS)**
- **Isolamento por usuário**: cada trainer vê apenas seus dados
- **Políticas automáticas** para todas as tabelas
- **Segurança na API** e consultas diretas
- **Auditoria completa** de acessos

#### **Autenticação**
- **Supabase Auth** integrado
- **Sessions persistentes** e seguras
- **Logout automático** por inatividade
- **Recuperação de senha** por email

## �️ Arquitetura e Performance

### **Otimizações de Performance**

#### **Frontend Optimizations**
- **Turbopack** - Build system ultrarrápido do Next.js
- **React Query (TanStack)** - Cache inteligente e sincronização
- **Code Splitting** automático por rotas e componentes
- **Image Optimization** nativa do Next.js
- **Lazy Loading** para componentes pesados
- **Memoization** estratégica com React.memo e useMemo

#### **Database Optimizations**
- **Índices otimizados** para queries frequentes
- **Prepared Statements** para segurança e performance
- **Connection Pooling** via Supabase
- **Row Level Security** sem impacto na performance
- **Realtime subscriptions** com filtros eficientes

#### **Caching Strategy**
- **Vercel KV** para cache de sessões e dados frequentes
- **React Query** cache em memória com TTL inteligente
- **Browser caching** otimizado para assets estáticos
- **Edge caching** via Vercel Edge Network
- **Database query caching** automático

### **Hooks Customizados Avançados**

#### **Data Management Hooks**
- `useOptimizedDashboardStats` - Estatísticas com cache inteligente
- `useRealtimeTasks` - Sincronização de tarefas em tempo real
- `useLeadMutations` - CRUD otimizado para leads
- `useAppointmentMutations` - Gerenciamento de agendamentos
- `useCalendarEvents` - Eventos do calendário com cache
- `useAdvancedAnalytics` - Analytics avançados com métricas

#### **WhatsApp Integration Hooks**
- `useWhatsAppConnection` - Gerenciamento de conexão
- `useWhatsAppMessages` - Mensagens com realtime
- `useMessageMutations` - Envio e recebimento otimizado

#### **Performance Hooks**
- `useDebounce` - Debounce para inputs de busca
- `useInfiniteScroll` - Paginação infinita otimizada
- `useVirtualization` - Listas grandes virtualizadas
- `useOptimisticUpdates` - Atualizações otimistas

### **Evolution API (WhatsApp) - Integração Otimizada**

#### **Nova Arquitetura HTTP**
- **Fetch Nativo** substituindo Axios para melhor performance
- **Sistema de Retry** com backoff exponencial e jitter
- **Error Classification** - Network, API, Rate Limit errors
- **Request Timeout** configurável (padrão: 30s)
- **Circuit Breaker** para proteção contra falhas
- **Connection Pooling** para reutilização de conexões

#### **Configuração Avançada**
```env
# Core Configuration
EVOLUTION_API_URL=https://evolution-api.domain.com
EVOLUTION_API_KEY=your-api-key
WHATSAPP_INSTANCE_NAME=Leonardo
NEXT_PUBLIC_WEBHOOK_URL=https://your-app.com/api/whatsapp/webhook

# Performance Tuning (opcional)
HTTP_TIMEOUT=30000
HTTP_RETRIES=3
RATE_LIMIT_WINDOW=60000
RATE_LIMIT_MAX=30
```

#### **Endpoints Otimizados**
- `GET /instance/fetchInstances` - Status das instâncias (com cache)
- `GET /instance/connect/{instance}` - Conectar instância (com retry)
- `POST /message/sendText/{instance}` - Enviar texto (com confirmação)
- `POST /message/sendMedia/{instance}` - Enviar mídia (upload otimizado)
- `POST /webhook/set/{instance}` - Configurar webhook (validação)
- `DELETE /instance/logout/{instance}` - Desconectar (cleanup)

#### **Webhook Events Processados**
- `CONNECTION_UPDATE` - Status da conexão com persistência
- `MESSAGES_UPSERT` - Novas mensagens com auto-criação de leads
- `MESSAGES_UPDATE` - Status de mensagens (lida/entregue)
- `MESSAGES_DELETE` - Mensagens deletadas
- `CHATS_UPSERT` - Novos chats com metadados
- `CONTACTS_UPSERT` - Atualizações de contatos
- `SEND_MESSAGE` - Confirmação de envio
- `QRCODE_UPDATED` - Novo QR Code disponível

### **Supabase Realtime**

#### **Subscriptions Ativas Otimizadas**
- **whatsapp_messages**: Mensagens em tempo real com cache invalidation
- **whatsapp_connections**: Status de conexão com persistência
- **tasks**: Atualizações de tarefas
- **leads**: Mudanças nos leads com auto-refresh

#### **Melhorias na Visibilidade de Mensagens**
- **Real-time Subscriptions**: Adicionadas em todos os componentes de chat
- **Cache Invalidation**: Invalidação automática após envio de mensagens
- **Query Refresh**: Atualização forçada após operações críticas
- **Fallback Polling**: Refresh a cada 5 segundos como backup
- **Error Recovery**: Reconexão automática em caso de falhas

## 🎨 Interface e UX

### **Design System**

#### **Paleta de Cores**
- **Primary**: Sistema baseado no tema escuro/claro
- **Company Colors**: 
  - Favale Functional: Verde (#22c55e)
  - Personal Training: Azul (#3b82f6)
  - FIT: Roxo (#8b5cf6)

#### **Componentes**
- **Design consistente** com shadcn/ui
- **Acessibilidade** (ARIA, contraste, keyboard navigation)
- **Responsividade** mobile-first
- **Loading states** e skeleton screens
- **Error boundaries** para estabilidade

#### **Temas**
- **Light/Dark mode** automático
- **Persistência** da preferência
- **Transições suaves** entre temas
- **Compatibilidade** com preferências do sistema

### **Navegação**

#### **Sidebar Inteligente**
- **Ícones intuitivos** com labels
- **Estados ativos** destacados
- **Contadores dinâmicos** (tarefas pendentes, mensagens)
- **Collapse/expand** para economizar espaço

#### **Breadcrumbs**
- **Navegação contextual** em páginas profundas
- **Histórico preservado** ao voltar
- **Links funcionais** para navegação rápida

## 📊 Métricas e Analytics

### **KPIs Monitorados**

#### **Vendas e Conversão**
- **Leads por período** (diário, semanal, mensal)
- **Taxa de conversão** leads → alunos
- **Tempo médio** para conversão
- **Fontes mais efetivas** de leads
- **Performance por personal trainer**

#### **Operacional**
- **Tarefas completadas** vs pendentes
- **Tempo de resposta** no WhatsApp
- **Sessões agendadas** vs realizadas
- **Taxa de no-show** dos alunos

#### **Engajamento**
- **Interações por lead** (calls, whatsapp, emails)
- **Tempo médio** de resposta
- **Satisfação** baseada em conversões
- **Retenção** de alunos

### **Relatórios Automatizados**

#### **Dashboard Executive**
- **Visão consolidada** de métricas principais
- **Comparativos** período anterior
- **Tendências** e projeções
- **Alertas** de performance

#### **Relatórios Personalizados**
- **Filtros avançados** por período, trainer, empresa
- **Exportação** PDF/CSV
- **Agendamento** de relatórios recorrentes
- **Compartilhamento** com stakeholders

## 🚀 Deploy e Infraestrutura

### **Vercel (Frontend)**
- **Deploy automático** via Git push
- **Edge Functions** para performance
- **Domain customizado** com SSL
- **Analytics** e monitoring integrados

### **Supabase (Backend)**
- **Database PostgreSQL** na nuvem
- **Automatic backups** diários
- **SSL/TLS** por padrão
- **Monitoring** de performance

### **Evolution API**
- **Self-hosted** em servidor dedicado
- **Docker containerized**
- **Reverse proxy** (Nginx)
- **Monitoring** de uptime

### **Configuração de Ambiente**

#### **Variáveis de Ambiente - Desenvolvimento**
```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Evolution API Configuration
EVOLUTION_API_URL=https://evolution.yourdomain.com
EVOLUTION_API_KEY=your-evolution-key
WHATSAPP_INSTANCE_NAME=Leonardo
NEXT_PUBLIC_WEBHOOK_URL=http://localhost:3000/api/whatsapp/webhook

# Optional: Vercel KV for caching
KV_URL=your-vercel-kv-url
KV_REST_API_URL=your-kv-rest-url
KV_REST_API_TOKEN=your-kv-token
```

#### **Variáveis de Ambiente - Produção**
```env
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Evolution API Configuration
EVOLUTION_API_URL=https://evolution.yourdomain.com
EVOLUTION_API_KEY=your-evolution-key
WHATSAPP_INSTANCE_NAME=Leonardo
NEXT_PUBLIC_WEBHOOK_URL=https://yourapp.vercel.app/api/whatsapp/webhook

# Vercel KV for Production Caching
KV_URL=your-vercel-kv-url
KV_REST_API_URL=your-kv-rest-url
KV_REST_API_TOKEN=your-kv-token
```

#### **Configuração de Segurança**

##### **Supabase Security**
- **RLS Policies**: Habilitadas em todas as tabelas
- **User Authentication**: Supabase Auth integrado
- **API Keys**: Separação entre anon key e service role
- **Database**: SSL/TLS por padrão

##### **Evolution API Security**
- **API Key Authentication**: Chave única por instância
- **Webhook Validation**: Verificação de origem
- **Rate Limiting**: 30 mensagens/minuto
- **Instance Isolation**: Uma instância por usuário

##### **Best Practices**
```env
# NUNCA commitir no git
# Usar diferentes chaves para dev/prod
# Rotacionar chaves regularmente
# Monitorar uso de APIs
```

## 🔧 Desenvolvimento Local

### **Pré-requisitos**
- **Node.js 18+** (recomendado 18.17.0 ou superior)
- **npm/yarn/pnpm** (npm 9+ recomendado)
- **Git** para controle de versão
- **Conta Supabase** (tier gratuito suficiente para desenvolvimento)
- **Evolution API** configurada e acessível
- **Editor de código** (VS Code recomendado com extensões TypeScript)

### **Configuração Inicial**

#### **1. Clone e Instale Dependências**
```bash
git clone <repository-url>
cd NextCRM
npm install
```

#### **2. Configure Variáveis de Ambiente**
```bash
# Crie o arquivo de ambiente local
cp .env.example .env.local

# Configure as seguintes variáveis:
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# Evolution API
EVOLUTION_API_URL=https://evolution.yourdomain.com
EVOLUTION_API_KEY=your-evolution-key
WHATSAPP_INSTANCE_NAME=Leonardo
NEXT_PUBLIC_WEBHOOK_URL=http://localhost:3000/api/whatsapp/webhook

# Opcional: Vercel KV (para cache)
KV_URL=your-vercel-kv-url
KV_REST_API_URL=your-kv-rest-url
KV_REST_API_TOKEN=your-kv-token
```

#### **3. Configure Supabase**
```bash
# Execute as migrations do banco de dados
npx supabase db push

# Configure as políticas RLS (Row Level Security)
# As políticas são aplicadas automaticamente via migrations

# Opcional: Adicione dados de exemplo
npm run seed  # (se disponível)
```

#### **4. Inicie o Servidor de Desenvolvimento**
```bash
npm run dev
# Aplicação disponível em http://localhost:3000
```

### **Scripts Disponíveis**
```json
{
  "dev": "next dev --turbopack",      // Servidor de desenvolvimento com Turbopack
  "build": "next build --turbopack",  // Build otimizado para produção com Turbopack
  "start": "next start",              // Servidor de produção
  "lint": "next lint"                 // Verificação de qualidade do código
}
```

### **Comandos Úteis para Desenvolvimento**

#### **Verificação de Tipos**
```bash
npx tsc --noEmit  # Verificação de tipos TypeScript
```

#### **Linting e Formatação**
```bash
npm run lint      # Verificação de regras ESLint
npm run lint:fix  # Correção automática de problemas
```

#### **Teste de Webhook (Desenvolvimento)**
```bash
# Teste de configuração do webhook
node check-webhook-config.js

# Diagnóstico completo
node diagnose-webhook.js

# Teste com mensagens reais
node test-webhook-real.js
```

## 🧪 Testes e Qualidade

### **Estratégia de Testes**

#### **Verificação de Tipos**
- **TypeScript** em modo estrito para prevenção de erros
- **Configuração rigorosa** no tsconfig.json
- **Tipos personalizados** para database e APIs
- **Validação em tempo de compilação**

#### **Qualidade de Código**
- **ESLint** com configuração Next.js
- **Prettier** para formatação consistente
- **Conventional commits** para versionamento
- **Code review** obrigatório para PRs

#### **Testes de Integração**
- **Scripts de teste** para Evolution API
- **Webhook testing** com cenários reais
- **Database migrations** testadas
- **Supabase RLS** validado

### **Ferramentas de Teste Disponíveis**

#### **Webhook Testing**
```bash
# Teste de configuração básica
node check-webhook-config.js

# Diagnóstico completo da integração
node diagnose-webhook.js

# Simulação de mensagens reais
node test-webhook-real.js

# Teste de eventos específicos
node test-webhook-specific-events.js

# Teste de rotas catch-all
node test-catch-all-routes.js
```

#### **Database Testing**
```bash
# Verificação de migrations
npx supabase db diff

# Teste de políticas RLS
npx supabase db test

# Verificação de tipos
npx supabase gen types typescript
```

### **Monitoramento e Observabilidade**

#### **Performance Monitoring**
- **Vercel Analytics** para métricas web vitais
- **Core Web Vitals** (LCP, FID, CLS) monitorados
- **React Query DevTools** para debugging
- **Next.js Built-in Analytics** para performance

#### **Error Tracking**
- **Error Boundaries** React para captura de erros
- **Structured logging** com prefixos contextuais
- **API monitoring** com status codes detalhados
- **WhatsApp integration** logging com timestamps

#### **Logs Estruturados**
```javascript
// Exemplo de logging estruturado
console.log('[WEBHOOK]', 'Message received:', {
  timestamp: new Date().toISOString(),
  messageId: data.messageId,
  from: data.from,
  type: data.type
});
```

### **Debugging e Troubleshooting**

#### **React Query DevTools**
- **Query inspection** em desenvolvimento
- **Cache invalidation** debugging
- **Network requests** monitoring
- **Mutation tracking** para operações

#### **Supabase Debugging**
- **Real-time subscriptions** monitoring
- **Database queries** performance
- **RLS policies** testing
- **Auth flow** debugging

#### **WhatsApp Integration Debug**
- **Webhook payload** inspection
- **Message flow** tracking
- **Connection status** monitoring
- **Rate limiting** verification

## 📈 Roadmap e Melhorias Futuras

### **Curto Prazo (1-3 meses)**
- [ ] **Notificações push** para tarefas e mensagens
- [ ] **Templates** de mensagens WhatsApp personalizáveis
- [ ] **Backup/restore** automático de dados
- [ ] **Sistema de lembretes** inteligente
- [ ] **Integração** com Google Calendar/Outlook
- [ ] **Relatórios financeiros** básicos
- [ ] **Dashboard mobile** responsivo
- [ ] **Bulk actions** para operações em massa

### **Médio Prazo (3-6 meses)**
- [ ] **App móvel** (React Native/PWA)
- [ ] **Integração calendário** (Google Calendar)
- [ ] **Automações** de marketing avançadas
- [ ] **AI para análise** de sentimento em mensagens
- [ ] **Multi-tenant** para múltiplas empresas
- [ ] **API pública** para integrações externas
- [ ] **Webhooks personalizados** para automações
- [ ] **Relatórios PDF** com templates customizáveis

### **Longo Prazo (6+ meses)**
- [ ] **Pagamentos integrados** (Stripe/PagSeguro/Pix)
- [ ] **CRM avançado** com funil de vendas complexo
- [ ] **Marketplace** de personal trainers
- [ ] **Analytics preditivos** com Machine Learning
- [ ] **Integrações** com equipamentos fitness (IoT)
- [ ] **Sistema de gamificação** para alunos
- [ ] **Plataforma de cursos** online integrada
- [ ] **Chatbot inteligente** com IA para atendimento

## 🛠️ Configurações e Personalizações

### **Next.js Configuration**
```javascript
// next.config.js
module.exports = {
  eslint: {
    ignoreDuringBuilds: true,  // Para builds mais rápidos
  },
  images: {
    unoptimized: true,         // Para compatibilidade
  },
  typescript: {
    ignoreBuildErrors: false,  // Type checking habilitado
  }
};
```

### **TypeScript Configuration**
```json
{
  "compilerOptions": {
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "moduleResolution": "node",
    "jsx": "preserve",
    "allowJs": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
```

### **Tailwind CSS Configuration**
```javascript
// tailwind.config.ts
module.exports = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        'favale-functional': '#22c55e',
        'personal-training': '#3b82f6',
        'fit': '#8b5cf6',
      }
    }
  },
  plugins: [require('tailwindcss-animate')]
};
```

## 🤝 Contribuição e Desenvolvimento

### **Workflow de Desenvolvimento**

#### **Git Flow**
```bash
# Criar nova feature
git checkout -b feature/nova-funcionalidade

# Commits convencionais
git commit -m "feat: adicionar nova funcionalidade"
git commit -m "fix: corrigir bug no login"
git commit -m "docs: atualizar documentação"

# Push e PR
git push origin feature/nova-funcionalidade
# Criar Pull Request no GitHub
```

#### **Conventional Commits**
- `feat:` - Nova funcionalidade
- `fix:` - Correção de bug
- `docs:` - Alterações na documentação
- `style:` - Mudanças que não afetam o código
- `refactor:` - Refatoração de código
- `test:` - Adição ou correção de testes
- `chore:` - Tarefas de manutenção

### **Estrutura de Code Review**

#### **Checklist de Review**
- [ ] **Funcionalidade** implementada corretamente
- [ ] **Testes** adicionados quando necessário
- [ ] **TypeScript** sem erros
- [ ] **ESLint** sem warnings
- [ ] **Performance** considerada
- [ ] **Security** verificada
- [ ] **Documentação** atualizada

#### **Critérios de Qualidade**
- **Componentes** reutilizáveis e bem estruturados
- **Hooks customizados** para lógica complexa
- **Error handling** apropriado
- **Loading states** implementados
- **Responsive design** considerado

### **Documentação e Suporte**

#### **Documentação Técnica**
- **CLAUDE.MD** - Visão geral completa do projeto
- **README.md** - Setup básico e instruções
- **WHATSAPP_INTEGRATION.md** - Configuração WhatsApp
- **API.md** - Documentação das APIs
- **DEPLOYMENT.md** - Guia de deploy

#### **Inline Documentation**
```typescript
/**
 * Hook para gerenciar conexões WhatsApp
 * @returns {Object} Estado da conexão e funções de controle
 */
function useWhatsAppConnection() {
  // Implementação...
}
```

#### **Componente Documentation**
```typescript
interface LeadTableProps {
  /** Lista de leads para exibir */
  leads: Lead[];
  /** Função callback para seleção */
  onLeadSelect: (lead: Lead) => void;
  /** Habilita seleção múltipla */
  multiSelect?: boolean;
}
```

### **Suporte e Comunicação**

#### **Canais de Comunicação**
- **GitHub Issues** - Bugs e solicitações de features
- **GitHub Discussions** - Perguntas gerais e ideias
- **Pull Requests** - Code review e colaboração
- **Slack/Discord** - Comunicação rápida da equipe

#### **Processo de Suporte**
1. **Verificar** documentação existente
2. **Buscar** issues similares no GitHub
3. **Criar** issue detalhada se necessário
4. **Fornecer** logs e contexto relevante
5. **Seguir** template de issue quando disponível

## 📚 Recursos Adicionais

### **Extensões VS Code Recomendadas**
```json
{
  "recommendations": [
    "ms-vscode.vscode-typescript-next",
    "bradlc.vscode-tailwindcss",
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "ms-vscode.vscode-json",
    "formulahendry.auto-rename-tag",
    "christian-kohler.path-intellisense"
  ]
}
```

### **Snippets e Produtividade**

#### **Componente React Template**
```typescript
// rfc - React Functional Component
import React from 'react';

interface ComponentNameProps {
  // Props interface
}

const ComponentName: React.FC<ComponentNameProps> = (props) => {
  return (
    <div>
      {/* Component content */}
    </div>
  );
};

export default ComponentName;
```

#### **Custom Hook Template**
```typescript
// rhook - React Hook
import { useState, useEffect } from 'react';

interface UseHookNameReturn {
  // Return type
}

function useHookName(): UseHookNameReturn {
  // Hook logic
  return {
    // Return object
  };
}

export default useHookName;
```

### **Performance Tips**

#### **React Query Configuration**
```typescript
// Configuração otimizada para produção
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutos
      cacheTime: 10 * 60 * 1000, // 10 minutos
      retry: 3,
      refetchOnWindowFocus: false,
    },
  },
});
```

#### **Otimizações Next.js**
```typescript
// Dynamic imports para code splitting
const LazyComponent = dynamic(() => import('./LazyComponent'), {
  loading: () => <Skeleton />,
  ssr: false,
});

// Image optimization
import Image from 'next/image';

<Image
  src="/path/to/image.jpg"
  alt="Description"
  width={300}
  height={200}
  placeholder="blur"
  blurDataURL="data:image/..."
/>;
```

### **Troubleshooting Guide**

#### **Problemas Comuns**

**1. Webhook não recebe mensagens**
```bash
# Verificar configuração
node diagnose-webhook.js

# Testar conexão
curl -X POST https://your-app.com/api/whatsapp/webhook
```

**2. Erro de conexão Supabase**
```typescript
// Verificar configuração
console.log('Supabase URL:', process.env.NEXT_PUBLIC_SUPABASE_URL);
console.log('Supabase Key:', process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY?.slice(0, 10) + '...');
```

**3. Problemas de build**
```bash
# Limpar cache
rm -rf .next
npm run build

# Verificar tipos
npx tsc --noEmit
```

---

## 📝 Conclusão

O **FavaleTrainer CRM** representa uma solução moderna e completa para personal trainers, combinando as melhores práticas de desenvolvimento web com funcionalidades específicas do setor fitness. A arquitetura escalável, integração WhatsApp nativa e interface intuitiva fazem dele uma ferramenta poderosa para crescimento do negócio.

### **Principais Diferenciais**

- **Arquitetura Moderna**: Next.js 15 + TypeScript + Supabase + Turbopack
- **Performance Superior**: Otimizações avançadas e caching inteligente
- **Integração WhatsApp**: Nativa com Evolution API + Chatwoot
- **Sistema de Agendamento**: Calendário avançado com RRule e feriados
- **Real-time**: Atualizações instantâneas com Supabase Realtime
- **Multi-tenant**: Isolamento seguro de dados por usuário
- **Analytics Avançados**: Dashboard interativo com insights automáticos
- **UX/UI**: Design system consistente com shadcn/ui
- **Segurança**: RLS, autenticação robusta, validação de dados
- **Escalabilidade**: Preparado para crescimento empresarial
- **Hooks Customizados**: Lógica reutilizável e performática
- **Developer Experience**: TypeScript, ESLint, Hot Reload com Turbopack

### **Tecnologias de Ponta**

A escolha tecnológica (Next.js 15 + Supabase + Evolution API + Turbopack) garante:
- **Performance superior** com App Router, Turbopack e Edge Functions
- **Developer Experience** excepcional com hot reload ultrarrápido
- **Segurança enterprise** com Row Level Security e validações robustas
- **Facilidade de manutenção** com TypeScript rigoroso e ESLint
- **Experiência de usuário** profissional e responsiva
- **Integração perfeita** com WhatsApp Business via Chatwoot
- **Analytics avançados** com visualizações interativas
- **Sistema de agendamento** profissional com calendário completo

### **Próximos Passos**

Para começar a usar o FavaleTrainer CRM:
1. Siga o **guia de configuração local**
2. Configure suas **variáveis de ambiente**
3. Execute as **migrations do banco**
4. Conecte sua **instância WhatsApp**
5. Importe seus **leads iniciais**

**Versão do Documento**: 3.0  
**Última Atualização**: Janeiro 2025  
**Autor**: Equipe de Desenvolvimento Favale  
**Revisado por**: Claude AI Assistant  
**Novas Funcionalidades**: Sistema de Agendamento, Analytics Avançados, Performance Otimizada

## 🚀 Atualizações Recentes (Janeiro 2025)

### **Novas Funcionalidades Implementadas**

#### **Sistema de Agendamento Completo**
- ✅ **React Big Calendar** integrado com interface moderna
- ✅ **Calendário personalizado** com localização pt-BR
- ✅ **Agendamentos recorrentes** usando RRule
- ✅ **Gestão de disponibilidade** de professores
- ✅ **Sistema de serviços** com preços e durações
- ✅ **Feriados automáticos** do Brasil
- ✅ **Controle de ausências** e bloqueios de agenda

#### **Performance e Developer Experience**
- ✅ **Turbopack** habilitado para builds ultrarrápidos
- ✅ **Custom Hooks** avançados para toda aplicação
- ✅ **Otimizações de cache** com React Query
- ✅ **Hooks de mutação** especializados para cada domínio
- ✅ **TypeScript rigoroso** em todos os componentes
- ✅ **Activity Heatmap** para análise de padrões

#### **Melhorias na Integração WhatsApp**
- ✅ **Chatwoot integration** para interface externa
- ✅ **Schema consolidado** do banco de dados
- ✅ **Instância única** gerenciada pelo sistema
- ✅ **Realtime otimizado** para mensagens
- ✅ **Redirecionamento automático** para chat externo

#### **Analytics e Dashboard Avançados**
- ✅ **Dashboard interativo** com múltiplas visualizações
- ✅ **Gráficos de tendência** com Recharts
- ✅ **Métricas em tempo real** otimizadas
- ✅ **Comparativos automáticos** entre períodos
- ✅ **Insights baseados em dados** históricos

### **Melhorias Técnicas**

#### **Arquitetura e Performance**
- ✅ **Next.js 15.3.4** com App Router otimizado
- ✅ **React Query 5.17.0** para cache inteligente
- ✅ **Framer Motion 12.20.1** para animações fluidas
- ✅ **Lucide React 0.446.0** com ícones otimizados
- ✅ **Code splitting** automático por componente
- ✅ **Lazy loading** estratégico

#### **Database e Backend**
- ✅ **Migrações consolidadas** para WhatsApp
- ✅ **Funções SQL otimizadas** para chat lists
- ✅ **Índices de performance** em queries críticas
- ✅ **RLS policies** simplificadas e eficientes
- ✅ **Realtime subscriptions** com filtros
- ✅ **Triggers automáticos** para updated_at

#### **Componentes e UI**
- ✅ **LeadSheet** refatorado com múltiplas abas
- ✅ **TaskEditCard** com interface moderna
- ✅ **FilterPanel** com debounce otimizado
- ✅ **BatchOperations** para ações em massa
- ✅ **ScheduleCalendar** com eventos dinâmicos
- ✅ **AppointmentDialog** para criação de agendamentos

### **APIs e Endpoints Atualizados**

#### **API Routes Implementadas**
- ✅ `GET/POST /api/leads/import` - Importação de leads em lote
- ✅ `POST /api/leads/import/batch` - Processamento em chunks
- ✅ `GET /api/leads/import/batch/status/[jobId]` - Status do processamento
- ✅ `POST /api/leads/import/batch/complete` - Finalização do lote
- ✅ `POST /api/leads/import/batch/chunk` - Chunk individual
- ✅ `GET/POST /api/users` - Gerenciamento de usuários
- ✅ `GET/PUT/DELETE /api/users/[id]` - Operações por usuário

#### **Hooks de Performance**
```typescript
// Hooks especializados para diferentes domínios
useOptimizedDashboardStats()    // Dashboard com cache inteligente
useRealtimeTasks()              // Tarefas com sincronização automática
useLeadMutations()              // CRUD otimizado para leads
useAppointmentMutations()       // Agendamentos com validações
useCalendarEvents()             // Eventos do calendário com cache
useAdvancedAnalytics()          // Analytics com métricas complexas
```

#### **Mutações Especializadas**
```typescript
// Mutações para leads com cache invalidation
const createLeadMutation = useCreateLeadMutation(userId);
const updateLeadMutation = useUpdateLeadMutation(userId);
const deleteLeadMutation = useDeleteLeadMutation(userId);
const batchUpdateLeadsMutation = useBatchUpdateLeadsMutation(userId);

// Mutações para agendamentos com conflito detection
const createAppointmentMutation = useCreateAppointmentMutation();
const updateAppointmentMutation = useUpdateAppointmentMutation();
const deleteAppointmentMutation = useDeleteAppointmentMutation();
```

### **Funcionalidades do Sistema de Agendamento**

#### **Tabelas Implementadas**
- ✅ `recurring_sessions` - Agendamentos recorrentes com RRule
- ✅ `teacher_availability` - Disponibilidade por dia da semana
- ✅ `teacher_absences` - Ausências e bloqueios de agenda
- ✅ `services` - Catálogo de serviços com preços
- ✅ `holidays` - Feriados nacionais e personalizados

#### **Recursos do Calendário**
- ✅ **Visualizações múltiplas**: Mês, semana, dia, agenda
- ✅ **Eventos coloridos** por tipo de serviço
- ✅ **Drag & drop** para reagendamentos
- ✅ **Conflict detection** automático
- ✅ **Recurring events** com padrões complexos
- ✅ **Holiday integration** com date-holidays
- ✅ **Timezone handling** correto para Brasil

#### **Gestão de Disponibilidade**
- ✅ **Horários por dia** da semana configuráveis
- ✅ **Bloqueios temporários** para férias
- ✅ **Exceções pontuais** facilmente gerenciadas
- ✅ **Capacidade por slot** de tempo
- ✅ **Overlap prevention** automático
